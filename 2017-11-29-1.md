# æµ…ææ¶æ„æ¨¡å¼

ä¸äº†è§£é¡¹ç›®æ¶æ„ï¼Œåç»­å°±æ— ä»ä¸‹æ‰‹

## MVVMæ¶æ„é¢„è§ˆ

é¡¹ç›®é‡‡ç”¨çš„æ˜¯MVVMæ¶æ„æ¨¡å¼ï¼Œå¦‚ä¸‹å›¾ï¼š
![WX20171129-234259@2x](http://ovblidthw.bkt.clouddn.com/2017-11-29-WX20171129-234259@2x.png)

é™¤äº† View ã€ViewModel å’Œ Model ä¹‹å¤–ï¼ŒMVVM ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„éšå«ç»„ä»¶ **binder** ã€‚



* View ï¼šç”± UIView å’Œ UIViewController ç»„æˆã€‚
* UIViewè´Ÿè´£ UI çš„å±•ç¤ºï¼Œä»¥åŠç”¨æˆ·äº¤äº’ã€‚
* **UIViewControlleråªç”¨æ¥åšä¸­è½¬å±‚ä¸å‚ä¸ä¸šåŠ¡é€»è¾‘ç­‰å¤„ç†ã€‚**
* UIViewControllerï¼Œä¹Ÿå¯ç§°ä¸º**èƒ¶æ°´å±‚**ï¼Œå¯¹ä¸Š(View)åªæä¾›é¡µé¢å±•ç¤ºæ‰€éœ€æ•°æ®ï¼Œå¯¹ä¸‹è°ƒç”¨(ViewModel)æš´éœ²å‡ºçš„ä¸šåŠ¡é€»è¾‘æ¥å£ã€‚
* ViewModel: å®ç°æ•´ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œè´Ÿè´£ä» Model ä¸­è·å– View æ‰€éœ€çš„æ•°æ®ï¼Œè½¬æ¢æˆ View å¯ä»¥å±•ç¤ºçš„æ•°æ®ï¼Œå¹¶æš´éœ²å…¬å¼€çš„å±æ€§å’Œå‘½ä»¤ä¾› View è¿›è¡Œç»‘å®šã€‚
* Model: æ•°æ®æ¨¡å‹å±‚
* **binder** ï¼šåœ¨ MVVM ä¸­ï¼Œå£°æ˜å¼çš„æ•°æ®å’Œå‘½ä»¤ç»‘å®šæ˜¯ä¸€ä¸ªéšå«çš„çº¦å®šï¼Œå®ƒå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç° view å’Œ viewModel çš„åŒæ­¥ï¼Œé¿å…ç¼–å†™å¤§é‡ç¹æ‚çš„æ ·æ¿åŒ–ä»£ç ã€‚

## ä¸¾ä¸ªğŸŒ°

æ‹¿é¡¹ç›®çš„ä¾‹å­ä¸¾ç¤ºä¾‹ï¼š

ä¸€ä¸ªå‘çŸ­ä¿¡éªŒè¯ç çš„ç•Œé¢ï¼Œæœ‰å¦‚ä¸‹ç±»ï¼š

![](http://ovblidthw.bkt.clouddn.com/2017-11-30-15119764373036.jpg)


1. JFSendSmsCodeViewï¼ŒJFSendSmsCodeViewController åŒå±Viewå±‚ã€‚
2. JFSendSmsCodeViewModel å±äºVieModelå±‚ã€‚JFSendSmsCodeViewModelProtocol æš´éœ²æ•°æ®ï¼Œä»¥åŠç›¸å…³æŒ‡ä»¤æ¥å£ã€‚
3. å› ä¸ºä¸éœ€è¦å¯¹å“åº”çš„æ•°æ®å¤„ç†ï¼Œå¯ä»¥ä¸éœ€è¦Modelå±‚ã€‚

å…ˆçœ‹**JFSendSmsCodeView.m**çš„ä»£ç ,ï¼š

```

@implementation JFSendSmsCodeView

- (instancetype)init {
    self = [super initWithFrame:[UIScreen mainScreen].bounds];
    if (self) {
        self.backgroundColor = [self.resourceService colorForKey:COLOR_WHITE_COLOR];
        [self createSubViews];
    }
    return self;
}

- (void)createSubViews {
    // å·´æ‹‰å·´æ‹‰ éƒ½æ˜¯UIä»£ç 
    ....
}

// é‡ç‚¹æ˜¯è¯¥æ–¹æ³•ï¼š

- (void)bindViewModel:(id<JFSendSmsCodeViewModelProtocol>)viewModel {
    self.viewModel = viewModel;
    // passwordTextField çš„ textä¿¡å·ä¸ViewModelçš„passwordç»‘å®šã€‚
    RAC(viewModel, password) = self.passwordTextField.rac_textSignal;
    // smsCodeTextField çš„ textä¿¡å·ä¸ViewModelçš„smsCodeç»‘å®š
    RAC(viewModel, smsCode) = self.smsCodeTextField.rac_textSignal;
    // registerButton æ³¨å†ŒæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸ viewModel çš„æ³¨å†Œäº‹ä»¶ç»‘å®š
    self.registerButton.rac_command = viewModel.registerCommand;
    // sendSmsButton å‘é€çŸ­ä¿¡çš„ç‚¹å‡»äº‹ä»¶ä¸ viewModelçš„å‘é€çŸ­ä¿¡äº‹ä»¶ç»‘å®š
    self.sendSmsButton.rac_command = viewModel.resendSmsCodeCommand;
    //ViewModel çš„ password å±æ€§ä¸ textField çš„rightView çš„hiddenå±æ€§ç»‘å®š
    @weakify(self)
    [RACObserve(self.viewModel, password) subscribeNext:^(NSString *x) {
        @strongify(self)
        if (x.length) {
            self.passwordTextField.textfieldRightView.hidden = NO;
        } else {
            self.passwordTextField.textfieldRightView.hidden = YES;
        }
    }];
    .......
    [RACObserve(self.passwordTextField, text) subscribeNext:^(NSString *x) {
        @strongify(self)
        self.viewModel.password = x;// æ²¡è§¦å‘rac_textSignal æ‰€ä»¥æ‰‹åŠ¨èµ‹å€¼
    }];
    [RACObserve(self.viewModel, smsCode) subscribeNext:^(NSString *x) {
        @strongify(self)
        self.passwordTextField.textfieldRightView.hidden = YES;
    }];
    ......
    [[self.unReceiveSmsCodeButton rac_signalForControlEvents:UIControlEventTouchUpInside] subscribeNext:^(id x) {
        [JFDataStatisticsManager setEventID:JFDS_ID_3101002];
        JFUnReceiveSmsCodeAlertView *alert = [[JFUnReceiveSmsCodeAlertView alloc] init];
        [alert show];
    }];
}

....
@end

```

å»é™¤äº†å¾ˆå¤šæ­å»ºUIçš„ä»£ç ï¼Œå‰©ä¸‹å°±å°±æ˜¯****ç»‘å®š****ä»£ç ï¼Œå½“è°ƒç”¨**bindViewModel:**æ–¹æ³•ä¼ è¿›æ¥ä¸€ä¸ªViewModelçš„æ—¶å€™ï¼ŒViewå°±ä¼šä¸ViewModelæš´éœ²çš„å±æ€§æˆ–è€…äº‹ä»¶è¿›è¡Œç»‘å®šã€‚
å°±å¦‚ä¸Šé¢æåˆ°çš„**UIViewè´Ÿè´£UIçš„å±•ç¤ºï¼Œä»¥åŠç”¨æˆ·äº¤äº’**ï¼Œ

å†çœ‹**JFSendSmsCodeViewController**çš„ä»£ç ï¼š



```

-(void)loadView {
    self.view = [[JFSendSmsCodeView alloc]init];
}
- (void)bindViewModel {
    [super bindViewModel];
    [self.view bindViewModel:self.viewModel];
}
//è¿”å›æŒ‰é’®çš„äº‹ä»¶
- (void)leftBarItemClicked:(id)sender {
    [self.view endEditing:YES];
    NSString *giveUpRegisterTitle = [self.resourceService stringForKey:STRING_REGISTER_GIVE_UP_ALERT];
    NSString *goOnRegiserTitle = (self.viewModel.type == 1)?[self.resourceService stringForKey:STRING_REGISTER_GO_ON_ALERT]:@"ç»§ç»­æ‰¾å›";
    NSString *msg = (self.viewModel.type == 1)?[self.resourceService stringForKey:STRING_REGISTER_BACK_ALERT]:@"æ˜¯å¦æ”¾å¼ƒæ‰¾å›ç™»å½•å¯†ç ";
    NSArray *alertBtnArray = @[giveUpRegisterTitle,goOnRegiserTitle];
    [self jf_showAlertWithTitle:nil message:msg buttonTitles:alertBtnArray andCallBack:^(BOOL cancelled, NSInteger buttonIndex) {
        if (buttonIndex == 0) {
            [self.viewModel.backCommand execute:nil];
        }
    }];
}
......
```
å¯ä»¥çœ‹åˆ°ViewControllerå°±æ˜¯ä¸€ä¸ªä¸­è½¬å±‚ï¼Œé€šè¿‡**bindViewModel**æ–¹æ³•å°†Viewä¸ViewModelç»‘å®šèµ·æ¥ï¼Œä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ã€‚ViewControllerä¹Ÿå½’å±Viewå±‚ï¼Œå°‘é‡çš„UIä»£ç ã€‚

æœ€åçœ‹JFSendSmsCodeViewModelï¼ŒViewModelå±‚ï¼š



```
@interface JFSendSmsCodeViewModel()
{
    NSMutableArray *_observers;
}
@property (strong, nonatomic, readwrite) RACSignal *validRegisterSignal;
@property (strong, nonatomic, readwrite) RACCommand *registerCommand;
@property (strong, nonatomic, readwrite) RACCommand *backCommand;
@property (strong, nonatomic, readwrite) RACCommand *resendSmsCodeCommand;
@property (strong, nonatomic, readwrite) RACCommand *unReceiveSmsCodeCommand;
@property (strong, nonatomic, readwrite) RACCommand *countDownCommand;//å€’è®¡æ—¶
@property (strong, nonatomic, readwrite) RACCommand *gotoRegisterCommand;
@property (strong, nonatomic, readwrite) RACCommand *agreementCommand;
@property (copy, nonatomic) NSString *invitionCode;
@property (assign, nonatomic, readwrite) NSTimeInterval timeInterval;
@end

```
å¦‚ä¸Šä»£ç ï¼ŒViewModel å¯¹å¤–æš´éœ²äº†å¤§é‡çš„RACCommandï¼ˆå‘½ä»¤äº‹ä»¶ï¼‰ä»¥åŠæ•°æ®ï¼Œä¾›Viewå±‚è¿›è¡Œä½¿ç”¨ç»‘å®šã€‚å†çœ‹åˆå§‹åŒ–æ–¹æ³•**initialize**


```
- (void)initialize {
    [super initialize];
    self.title = (self.type == JFSmsCodeEnum_MODIFYLOGINPASSWORD)? [self.services.resourceService stringForKey:STRING_FINDPWD_TITLEBAR_TITLE2]:[self.services.resourceService stringForKey:STRING_REGISTER_TITLEBAR_TITLE2];
//è¿›å…¥é¡µé¢å¼€å¯å€’è®¡æ—¶ï¼ˆéªŒè¯ç è¯·æ±‚ä¸Šä¸€ä¸ªç•Œé¢ç‚¹å‡»ä¸‹ä¸€æ­¥è§¦å‘ï¼‰
    @weakify(self)
    self.countDownCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(id input) {
        @strongify(self)
        [self countDownTime];
        return [RACSignal empty];
    }];
    //é‡æ–°å‘é€éªŒè¯ç 
    self.resendSmsCodeCommand = [[RACCommand alloc] initWithEnabled:nil signalBlock:^RACSignal *(id input) {
        @strongify(self)
        [JFDataStatisticsManager setEventID:JFDS_ID_3101001];
        @weakify(self)
        return [[[[self.services.accountService sendSmsCodeWithMobile:self.mobile type:@(self.type)] takeUntil:self.rac_willDeallocSignal]doNext:^(id x) {
            @strongify(self)
            [self countDownTime];
            }]takeUntil:self.rac_willDeallocSignal];
    }];
    [self subscribeErrors:@[self.resendSmsCodeCommand]];
    //éªŒè¯ç å’Œå¯†ç ä¸ä¸ºç©ºæ—¶æ³¨å†ŒæŒ‰é’®enable
    self.validRegisterSignal = [[RACSignal combineLatest:@[RACObserve(self, smsCode), RACObserve(self, password)] reduce:^(NSString *smsCode, NSString *password) {
    return @(smsCode.length > 0 && password.length > 0);
    }]distinctUntilChanged];
    
    if (self.type == JFSmsCodeEnum_MODIFYLOGINPASSWORD) {
        @weakify(self)
        //æ‰¾å›ç™»å½•å¯†ç 
        self.registerCommand = [[RACCommand alloc] initWithEnabled:self.validRegisterSignal signalBlock:^RACSignal *(id input) {
        @strongify(self)
        return [[[self.services.accountService forgetPwdWithMobile:self.mobile smsCode:self.smsCode password:self.password type:@1] doNext:^(id x) {
            @strongify(self)
            [self.services popTo:Router_Login animated:YES];
            [self sendInfoMsg:@"ç™»å½•å¯†ç å·²é‡ç½®ï¼Œè¯·é‡æ–°ç™»å½•ï¼"];
        }]takeUntil:self.rac_willDeallocSignal];
        [self subscribeErrors:@[self.registerCommand]];
    } else {
        ....
    }
    self.agreementCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(id input) {
        @strongify(self)
        [self.services pushTo:@"https://h5.9f.cn/act/project/app/2.4/help/serviceRule.html" animated:YES];
        return [RACSignal empty];
}];
}
```

éƒ½æ˜¯ä¸šåŠ¡é€»è¾‘çš„å…·ä½“å®ç°ã€‚æ¯”å¦‚ç‚¹å‡»å€’è®¡æ—¶çš„äº‹ä»¶ï¼Œå‘é€éªŒè¯ç äº‹ä»¶ï¼Œæ³¨å†Œäº‹ä»¶ã€‚**ViewModel ä¸å‚ä¸UIæ­å»ºå·¥ä½œï¼Œè´Ÿè´£æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼ŒçŠ¶æ€ï¼Œå¯¹å¤–æä¾›æ•°æ®ä¸äº‹ä»¶**ã€‚

å…¶ä¸­**binder**ç»‘å®šåŠŸèƒ½ç›¸å…³å®ç°ï¼ˆRACï¼‰çš„ä»£ç å†™åœ¨äº†Viewå±‚ä¸­ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„**bindViewModel:**æ–¹æ³•å®ç°ã€‚

## æ€»ç»“

å…ˆè¯´ä¼˜ç‚¹å§

**æ–¹ä¾¿æµ‹è¯•**

æœ‰äº†MVVMæˆ‘ä»¬å°±å¯ä»¥å•ç‹¬æµ‹è¯•viewModelé‡Œé¢äº‹ä»¶æ‰§è¡Œç»“æœæ¥éªŒè¯æˆ‘ä»¬çš„å¯¹ä¸šåŠ¡é€»è¾‘å¤„ç†å¯¹ä¸å¯¹ï¼Œè¿™æ˜¯åœ¨MVCä¸­Controllerä¸­æ— æ³•åšåˆ°çš„ã€‚

**ä¾¿äºé‡ç”¨**

å¯¹äºå…·æœ‰ç›¸åŒé€»è¾‘çš„ï¼Œä¸åŒç•Œé¢ä¸­ï¼Œé™¤äº†äº¤äº’å±•ç¤ºä¸ä¸€æ ·å¤–ï¼Œä¸šåŠ¡é€»è¾‘çš„modelæ˜¯ä¸€è‡´çš„ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»¥å¾ˆå°çš„ä»£ä»·å»å¼€å‘ï¼Œæé«˜ä»£ç çš„é‡ç”¨æ€§ã€‚

å½“ç„¶ä¹Ÿæœ‰ä¸å¥½çš„å¦ä¸€é¢

**ç±»ä¼šå¢å¤š**

æ¯ä¸ªVCéƒ½é™„å¸¦ä¸€ä¸ªviewModelï¼Œç±»çš„æ•°é‡*2ï¼ˆå®é™…é¡¹ç›®è¿˜æ›´å¤æ‚ï¼‰ï¼Œå¯¹äºæ–°äººæ¥è®²ï¼Œä¸äº†è§£é¡¹ç›®æ¶æ„æ ¹æœ¬æ— ä»ä¸‹æ‰‹

**è°ƒç”¨å¤æ‚åº¦å¢åŠ **

æ¯å°ä¸€å±‚ï¼Œæ„å‘³ç€è¦å†™å¾ˆå¤šä»£ç å»èåˆä»–ä»¬çš„è½¬æ¢ã€‚





